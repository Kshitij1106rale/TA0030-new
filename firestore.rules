rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * VeriHire AI Security Rules
     * 
     * Philosophy:
     * This ruleset implements a dual-role access model (HR and Candidate) with strict 
     * structural segregation. The security model relies on path-based ownership 
     * and role-based access verified via document existence.
     */

    // --- Helper Functions ---

    function isSignedIn() {
      return request.auth != null;
    }

    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }

    function isHR() {
      // Robust check for HR profile existence
      return isSignedIn() && exists(/databases/$(database)/documents/hr_profiles/$(request.auth.uid));
    }

    function isExistingOwner(userId) {
      return resource != null && isOwner(userId);
    }

    function isExistingHR() {
      return resource != null && isHR();
    }

    // --- Collection Rules ---

    match /hr_profiles/{hrProfileId} {
      allow get, list: if isOwner(hrProfileId);
      allow create: if isOwner(hrProfileId) && request.resource.data.id == hrProfileId;
      allow update, delete: if isExistingOwner(hrProfileId);
    }

    match /candidate_profiles/{candidateProfileId} {
      // HR can view all candidates; Candidates can view their own.
      allow get, list: if isOwner(candidateProfileId) || isHR();
      
      // Allow creation if the user is the candidate themselves OR an authenticated HR personnel.
      // We ensure the ID in the data matches the path to maintain data integrity.
      allow create: if (isOwner(candidateProfileId) || isHR()) && request.resource.data.id == candidateProfileId;
      
      // Allow updates if the user is the owner or an HR.
      allow update: if isExistingOwner(candidateProfileId) || isHR();
      allow delete: if isExistingOwner(candidateProfileId) || isHR();

      match /documents/{documentId} {
        allow get, list: if isOwner(candidateProfileId) || isHR();
        allow create: if (isOwner(candidateProfileId) || isHR()) && request.resource.data.candidateProfileId == candidateProfileId;
        allow update, delete: if isExistingOwner(candidateProfileId) || isHR();
      }

      match /extracted_data/{extractedDataId} {
        allow get, list: if isOwner(candidateProfileId) || isHR();
        allow create: if (isOwner(candidateProfileId) || isHR()) && request.resource.data.candidateProfileId == candidateProfileId;
        allow update, delete: if resource != null && (isOwner(candidateProfileId) || isHR());

        match /education_entries/{entryId} {
          allow get, list: if isOwner(candidateProfileId) || isHR();
          allow create: if (isOwner(candidateProfileId) || isHR()) && request.resource.data.extractedDataId == extractedDataId;
          allow update, delete: if resource != null && (isOwner(candidateProfileId) || isHR());
        }

        match /experience_entries/{entryId} {
          allow get, list: if isOwner(candidateProfileId) || isHR();
          allow create: if (isOwner(candidateProfileId) || isHR()) && request.resource.data.extractedDataId == extractedDataId;
          allow update, delete: if resource != null && (isOwner(candidateProfileId) || isHR());
        }
      }

      match /verification_workflows/{workflowId} {
        allow get, list: if isOwner(candidateProfileId) || isHR();
        // Allow both HR and Owner to create/update. This supports the candidate-triggered simulation.
        allow create: if (isOwner(candidateProfileId) || isHR()) && request.resource.data.candidateProfileId == candidateProfileId;
        allow update: if isExistingOwner(candidateProfileId) || isHR();
        allow delete: if isHR();

        match /mismatches/{mismatchId} {
          allow get, list: if isOwner(candidateProfileId) || isHR();
          allow create: if (isOwner(candidateProfileId) || isHR()) && request.resource.data.verificationWorkflowId == workflowId;
          allow update: if isExistingOwner(candidateProfileId) || isHR();
          allow delete: if isHR();
        }

        match /employment_gaps/{gapId} {
          allow get, list: if isOwner(candidateProfileId) || isHR();
          allow create: if (isOwner(candidateProfileId) || isHR()) && request.resource.data.verificationWorkflowId == workflowId;
          allow update: if isExistingOwner(candidateProfileId) || isHR();
          allow delete: if isHR();
        }
      }

      match /hiring_decisions/{decisionId} {
        allow get, list: if isOwner(candidateProfileId) || isHR();
        allow create: if isHR() && request.resource.data.hrProfileId == request.auth.uid && request.resource.data.candidateProfileId == candidateProfileId;
        allow update, delete: if isExistingHR() && resource.data.hrProfileId == request.auth.uid;
      }
    }
  }
}