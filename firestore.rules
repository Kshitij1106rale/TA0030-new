
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    function isSignedIn() {
      return request.auth != null;
    }

    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }

    function isHR() {
      return isSignedIn() && exists(/databases/$(database)/documents/hr_profiles/$(request.auth.uid));
    }

    match /hr_profiles/{hrProfileId} {
      allow get, list, create, update: if isOwner(hrProfileId);
    }

    match /candidate_profiles/{candidateProfileId} {
      // HR and the Owner can read and write candidate profiles
      allow get, list: if isSignedIn() && (isHR() || isOwner(candidateProfileId));
      allow create, update: if isSignedIn() && (isHR() || isOwner(candidateProfileId));
      allow delete: if isHR();

      match /documents/{documentId} {
        allow read, write: if isSignedIn() && (isHR() || isOwner(candidateProfileId));
      }

      match /verification_workflows/{workflowId} {
        allow read, write: if isSignedIn() && (isHR() || isOwner(candidateProfileId));
      }
    }

    match /audit_logs/{logId} {
      allow list, get: if isHR();
      allow create: if isHR();
    }
  }
}
